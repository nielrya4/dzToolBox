<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dzToolBox - {{ project_name }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='global/styles/table_list.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='global/styles/toolbars.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='editor/styles/frame.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='editor/styles/collapsible.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='editor/styles/MultiSelect.css') }}">
    <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
    <!-- Leaflet CSS and JS for Maps -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    {% include "editor/misc/font_style.html" %}
    {% include "global/head.html" %}
    <style>
        .settings-btn-hover:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 0.25rem;
        }
    </style>
</head>
<body style="overflow: hidden;" class="d-flex flex-column vh-100">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand me-3 d-flex align-items-center btn text-white settings-btn-hover" href="/projects">
                <i class="fa fa-arrow-circle-left" style="font-size: 1.5rem; margin-right: 0.5rem;"></i>
                Projects
            </a>
            <div class="d-flex align-items-center">
                <h5 class="mt-2 me-3">{{ project_name }}</h5>
                <button class="btn text-white settings-btn-hover" id="project_settings" data-bs-toggle="modal" data-bs-target="#project_settings_modal" title="Project Settings">
                    <i class="fa fa-cog fa-lg"></i>
                </button>
            </div>
            <ul class="nav nav-pills" id="my_tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link editor-tab active" id="spreadsheet_tab" onclick="showTab('spreadsheet')" type="button">
                        Spreadsheet
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link editor-tab" id="outputs_tab" onclick="showTab('outputs')" type="button">
                        Outputs
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link editor-tab" id="maps_tab" onclick="showTab('maps')" type="button">
                        Maps
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link editor-tab" id="dz_grainalyzer_tab" onclick="showTab('dz_grainalyzer')" type="button">
                        DZ Grainalyzer
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <div class="flex-grow-1" id="my_tab_content">
        <div class="h-100" id="spreadsheet_page" style="display: block;">
            {% include "editor/pages/data_table.html" %}
        </div>
        <div class="h-100" id="outputs_page" style="display: none;">
            {% include "editor/pages/outputs.html" %}
			<div style="overflow-y: auto; overflow-x: auto; height: calc(100vh - 140px); max-width: 100vw !important;" id="outputs_container">
				<div class="p-3">
					{% block outputs %}
						{% for output in outputs_data %}
							<div class="mb-3" style="max-width: 100%;">
								{{ output.output_data | safe }}
							</div>
						{% endfor %}
					{% endblock %}
				</div>
			</div>
        </div>
        <div class="h-100" id="maps_page" style="display: none;">
            {% include "editor/pages/maps.html" %}
        </div>
        <div class="h-100" id="dz_grainalyzer_page" style="display: none;">
            {% include "editor/pages/dz_grainalyzer.html" %}
        </div>
    </div>
    {% from "global/sample_select.html" import sample_select with context %}
    {% include "editor/modals/matrix_dialog.html" %}
    {% include "editor/modals/hafnium_dialog.html" %}
    {% include "editor/modals/mds_dialog.html" %}
    {% include "editor/modals/mda_dialog.html" %}
	{% include "editor/modals/tensor_dialog.html" %}
    {% include "editor/modals/distros_dialog.html" %}
    {% include "editor/modals/histogram_dialog.html" %}
    {% include "editor/modals/unmix_dialog.html" %}
    {% include "editor/modals/view_empirical_kdes_modal.html" %}
    {% include "editor/modals/find_optimal_rank_modal.html" %}
    {% include "editor/modals/run_factorization_modal.html" %}
    {% include "editor/modals/settings_dialog.html" %}
    {% include "editor/modals/databases_dialog.html" %}
    {% include "editor/modals/export_spreadsheet_dialog.html" %}
    {% include "editor/modals/import_data_dialog.html" %}
    {% include "editor/spinners/new_output_spinner.html" %}
    {% include "editor/spinners/clear_outputs_spinner.html" %}
    {% include "editor/spinners/delete_output_spinner.html" %}
    {% include "editor/spinners/get_settings_spinner.html" %}
    {% include "editor/spinners/update_settings_spinner.html" %}
    {% include "editor/modals/preview_output_dialog.html" %}
	{% include "editor/spinners/save_output_spinner.html" %}
	<script src="{{ url_for('static', filename='editor/scripts/collapsible.js')}}"></script>
    <script src="{{ url_for('static', filename='editor/scripts/MultiSelect.js')}}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
    
    <script>
    // Simple tab switching function
    function showTab(tabName) {
        // Hide all tab pages
        const spreadsheetPage = document.getElementById('spreadsheet_page');
        const outputsPage = document.getElementById('outputs_page');
        const mapsPage = document.getElementById('maps_page');
        const dzGrainalyzerPage = document.getElementById('dz_grainalyzer_page');

        if (spreadsheetPage) spreadsheetPage.style.display = 'none';
        if (outputsPage) outputsPage.style.display = 'none';
        if (mapsPage) mapsPage.style.display = 'none';
        if (dzGrainalyzerPage) dzGrainalyzerPage.style.display = 'none';

        // Remove active class from all tab buttons
        document.getElementById('spreadsheet_tab').classList.remove('active');
        document.getElementById('outputs_tab').classList.remove('active');
        document.getElementById('maps_tab').classList.remove('active');
        document.getElementById('dz_grainalyzer_tab').classList.remove('active');

        // Show selected tab and activate button
        if (tabName === 'spreadsheet') {
            if (spreadsheetPage) spreadsheetPage.style.display = 'block';
            document.getElementById('spreadsheet_tab').classList.add('active');
        } else if (tabName === 'outputs') {
            if (outputsPage) outputsPage.style.display = 'block';
            document.getElementById('outputs_tab').classList.add('active');
        } else if (tabName === 'maps') {
            if (mapsPage) mapsPage.style.display = 'block';
            document.getElementById('maps_tab').classList.add('active');

            // Trigger map initialization after tab is shown
            setTimeout(function() {
                if (typeof initializeMap === 'function') {
                    initializeMap();
                }
            }, 100);
        } else if (tabName === 'dz_grainalyzer') {
            if (dzGrainalyzerPage) dzGrainalyzerPage.style.display = 'block';
            document.getElementById('dz_grainalyzer_tab').classList.add('active');
        }
    }
	document.addEventListener('DOMContentLoaded', function() {
        console.log('Editor page loaded - new tab system');
        showTab('spreadsheet'); // Default to spreadsheet

        // Check for any active background jobs
        checkForActiveJobs();
    });

    // Global functions for managing background jobs
    var tensorJobPollingInterval = null;

    function disableOutputButtons() {
        var buttons = document.querySelectorAll('.toolbar-btn');
        buttons.forEach(function(btn) {
            btn.classList.add('disabled');
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.5';
        });
    }

    function enableOutputButtons() {
        var buttons = document.querySelectorAll('.toolbar-btn');
        buttons.forEach(function(btn) {
            btn.classList.remove('disabled');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
        });
    }

    // Flag to indicate if we're saving to grainalyzer_outputs or regular outputs
    let isGrainalyzerOutput = false;

    function pollTensorJobStatus(jobId) {
        tensorJobPollingInterval = setInterval(function() {
            fetch('/projects/{{ project_id }}/outputs/job-status/' + jobId)
                .then(function(response) {
                    if (!response.ok) throw new Error('Failed to get job status');
                    return response.json();
                })
                .then(function(data) {
                    if (data.status === 'completed') {
                        clearInterval(tensorJobPollingInterval);
                        hide_output_spinner();
                        enableOutputButtons();

                        // Check if outputs are available for preview (saved: false)
                        if (data.saved === false && data.outputs && data.outputs.length > 0) {
                            // Show preview modal with outputs
                            isGrainalyzerOutput = true; // Set flag for grainalyzer outputs
                            pendingOutputs = data.outputs;
                            var container = document.getElementById('preview_zoom_container');
                            container.innerHTML = pendingOutputs.map(function(o) {
                                return '<div class="mb-3">' + o.output_data + '</div>';
                            }).join('');
                            container.querySelectorAll('form').forEach(function(form) {
                                form.remove();
                            });

                            // Tell HTMX to process the preview content
                            if (typeof htmx !== 'undefined') {
                                htmx.process(container);
                            }

                            resetZoom();

                            // Initialize any tabbed outputs
                            setTimeout(function() {
                                if (typeof initializeTabbedOutputs === 'function') {
                                    initializeTabbedOutputs();
                                }
                            }, 100);

                            bootstrap.Modal.getOrCreateInstance(document.getElementById('preview_output_modal')).show();
                        } else {
                            // If outputs were auto-saved (old behavior), just refresh list
                            refreshGrainalyzerOutputsList();
                        }
                    } else if (data.status === 'failed') {
                        clearInterval(tensorJobPollingInterval);
                        hide_output_spinner();
                        enableOutputButtons();
                        alert('Tensor factorization failed: ' + (data.error || 'Unknown error'));
                    }
                    // If status is 'pending' or 'running', keep polling
                })
                .catch(function(error) {
                    console.error('Error polling job status:', error);
                    clearInterval(tensorJobPollingInterval);
                    hide_output_spinner();
                    enableOutputButtons();
                });
        }, 2000); // Poll every 2 seconds
    }

    function refreshOutputsList() {
        // Reload the outputs container
        fetch('/projects/{{ project_id }}/outputs')
            .then(function(response) {
                if (!response.ok) throw new Error('Failed to fetch outputs');
                return response.json();
            })
            .then(function(outputs) {
                var container = document.getElementById('outputs_container');
                if (container) {
                    // Try to find .p-3 child, otherwise use container directly
                    var targetElement = container.querySelector('.p-3');
                    if (!targetElement) {
                        targetElement = container;
                    }

                    // Build outputs HTML
                    var outputsHtml = outputs.map(function(output) {
                        return '<div class="mb-3" style="max-width: 100%;">' + output.output_data + '</div>';
                    }).join('');

                    targetElement.innerHTML = outputsHtml;

                    // Tell HTMX to process the dynamically added content
                    if (typeof htmx !== 'undefined') {
                        htmx.process(targetElement);
                    }
                }
            })
            .catch(function(error) {
                console.error('Error refreshing outputs:', error);
            });
    }

    function refreshGrainalyzerOutputsList() {
        console.log('Refreshing grainalyzer outputs...');
        // Reload the grainalyzer outputs container
        fetch('/projects/{{ project_id }}/grainalyzer/outputs')
            .then(function(response) {
                console.log('Grainalyzer outputs response:', response);
                if (!response.ok) throw new Error('Failed to fetch grainalyzer outputs');
                return response.json();
            })
            .then(function(outputs) {
                console.log('Grainalyzer outputs received:', outputs);
                console.log('Number of outputs:', outputs ? outputs.length : 0);

                // Update outputs container
                var outputsContainer = document.getElementById('dz_grainalyzer_outputs');

                console.log('Outputs container:', outputsContainer);

                // Build outputs HTML
                var outputsHtml = '';
                if (outputs && outputs.length > 0) {
                    outputsHtml = outputs.map(function(output) {
                        return '<div class="mb-3" style="max-width: 100%;">' + output.output_data + '</div>';
                    }).join('');
                } else {
                    outputsHtml = '<p class="text-muted">Run tensor factorization to see interactive results here</p>';
                }

                console.log('Setting outputs HTML, length:', outputsHtml.length);

                if (outputsContainer) {
                    outputsContainer.innerHTML = outputsHtml;
                    console.log('Updated outputs container');

                    // Tell HTMX to process the dynamically added content
                    if (typeof htmx !== 'undefined') {
                        htmx.process(outputsContainer);
                    }

                    // Initialize tabbed outputs after DOM update
                    setTimeout(function() {
                        if (typeof initializeTabbedOutputs === 'function') {
                            initializeTabbedOutputs();
                            console.log('Initialized tabbed outputs');
                        }
                    }, 100);
                }
            })
            .catch(function(error) {
                console.error('Error refreshing grainalyzer outputs:', error);
            });
    }

    function checkForActiveJobs() {
        fetch('/projects/{{ project_id }}/outputs/active-jobs')
            .then(function(response) {
                if (!response.ok) return;
                return response.json();
            })
            .then(function(data) {
                if (data && data.active_jobs && data.active_jobs.length > 0) {
                    // There are active jobs, disable buttons and start polling
                    console.log('Found active background jobs:', data.active_jobs);
                    show_output_spinner();
                    disableOutputButtons();

                    // Start polling for the first active job (assume one job at a time)
                    pollTensorJobStatus(data.active_jobs[0].job_id);
                } else {
                    // No active jobs - refresh outputs in case any completed while away
                    refreshOutputsList();
                }
            })
            .catch(function(error) {
                console.error('Error checking for active jobs:', error);
            });
    }
    </script>
</body>
</html>
