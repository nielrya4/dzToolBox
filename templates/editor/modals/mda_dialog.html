{% from "global/sample_select.html" import sample_select with context %}

<div id="mda_modal" class="modal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="frame" id="content">
                <div class="modal-header">
                    <h5 class="modal-title">New MDA</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <br />
                <div class="container-sm">
                    <form id="mda_form" data-hx-trigger="click">
                        <label for="mda_output_title" class="form-label">Output Title</label>
                        <input type="text" id="mda_output_title" name="mda_output_title" class="form-control" required>
                        <br />
                        <br />
                        {{ sample_select(id="mda_sample_select", sender="mda_link", event='click', multi_select=False) }}
                        <br />
                        <div class="table_list">
                            <table style="width: 100%;">
                                <tr>
                                    <td>
                                        <h6>Select Output Types</h6>
                                        <div id="mda_outputs_select"></div>
                                    </td>
                                    <td style="text-align: right; vertical-align: bottom;">
                                        <button class="btn btn-primary" type="button" onclick="mda_send_args();">Create model</button>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </form>
                    <br />
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const mdaSampleList = document.getElementById("mda_sample_select")
    function mda_send_args() {
        var selectedSamples = [];
        var mdaCheckboxes = mdaSampleList.querySelectorAll(".sample-checkbox");
        for (var i = 0; i < mdaCheckboxes.length; i++) {
            if (mdaCheckboxes[i].checked) {
                selectedSamples.push(mdaCheckboxes[i].value);
            }
        }
        const mdaOutputTitle = document.getElementById("mda_output_title").value;
        const mdaOutputsSelect = Array.from(
            document.querySelectorAll(`#mda_outputs_select input[type="hidden"]`)
        ).map(input => input.value);
        var encodedSamples = selectedSamples.map(s => encodeURIComponent(s));
        var queryString = "/projects/{{ project_id }}/outputs/new/mda?sampleNames="
            + encodedSamples.join("&sampleNames=")
            + "&outputType=" + mdaOutputsSelect.join("&outputType=");
        if (mdaOutputTitle !== "") {
            queryString += "&outputTitle=" + mdaOutputTitle;
        }
        var mdaModal = bootstrap.Modal.getInstance(document.getElementById('mda_modal'));
        if (mdaModal) {
            mdaModal.hide();
        }
        generateOutput(queryString);
    }
</script>

<script>
    // Focus on input when modal opens
    document.getElementById('mda_modal').addEventListener('shown.bs.modal', function() {
        document.getElementById('mda_output_title').focus();
    });
</script>
